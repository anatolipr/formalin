<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FL</title>
  </head>
  <body>
    <form onsubmit="this.reportValidity();return false">
    <div id="app"></div>
    <button onclick="save()">Save</button>
    </form>


    <script type="module" src="/src/main2.ts"></script>


    <script type="module">

      import { doParentFetch } from 'https://ui.impact.com/onboarding-ui/misc/fetch-utils.js'  

      doParentFetch(`/secure/nositemesh/checklist/getCheckboxMeta.json?checkBoxId={currentCheckId}`)
          .then((data) => {
            formFromJson(data);

            const fields = [];

            JSON.parse(data).sections.forEach(section => 
            
              section.fields.map(f => f.fieldName).filter(f => !!f)
              .forEach(field => {
                fields.push(`formData.${field}`)
              })

            );

            console.log('fields from metadata', fields)
            
            doParentFetch(`/secure/checklist/eventValues.json?id={instanceEid}&keys=${fields.join(',')}`)
            
            .then(data => {
              
              const parsed = JSON.parse(data);

              console.log('dataFromRules', data)

              const dataForUi = {}
              Object.keys(parsed).forEach(key => {
                // remove formData prefix
                const keyWithoutPrefix = key.replace('formData.', '')
                dataForUi[keyWithoutPrefix] = parsed[key] || ''
              })

              console.log('dataForUi', dataForUi )
              
              ___formData.set(dataForUi)
            })

          
          });

          window.save = function() {
            
            const valid = document.forms[0].reportValidity();

            if (!valid) {
              return;
            }
            console.log('saving')
            const b = ___formData.get()
            
            //update all keys to be prefixed with formData

            const formDataForBackend = Object.keys(b).reduce((acc, key) => {
              acc[`formData.${key}`] = b[key]
              return acc
            }, {})
            console.log('rule form Data', formDataForBackend)

            window.parent.postMessage({
              method: 'bulkRuleUpdate',
              b: formDataForBackend
            }, '*')

            window.parent.postMessage('MARK_AS_COMPLETE_AND_GO_TO_NEXT_CHECK', '*');
          }
    </script>

    <style>
      #app {
        padding: 20px;
      }
      button {
        background-color: rgb(114, 166, 250);
        color: white;
        margin: 20px;
      }
    </style>
  </body>
</html>
